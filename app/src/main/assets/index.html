
<!DOCTYPE html>
<html>

<head>
    <!--
   <script src="http://cdn.peerjs.com/0.3/peer.js"></script>
  -->
   <script src="file:///android_asset/peer.0.3.13.js"></script>
    <script src="file:///android_asset/jquery-2.1.3.min.js"></script>
</head>

<body>
    <input id="servbut" type="button" value="Start Server" />
    <textarea id="messout" rows="20" style="width: 100%; margin-top: 10px"></textarea>

<script>

var peer = null;
var shutdown = false;
var blobbuff = {};

var connectcnt = 0;
var lastcontime = 0;
var timer = null;
var cycletime = 60000 * 4;
//var toggler = 0;

var splitsz = 65536;

	$(document).ready(function(){
		messout("localhost : " + getParam("fullhost"));

		initall();

	//	var togg = getParam("toggle");

	//	console.log("In index togg : "+togg);
	//	if (togg.length > 0 ) {
	//	    toggler = parseInt(togg);
	//	    peerStartUp();
	//	}

	})

/*
function toggleOn(xtog) {

    console.log("In toggleOn xtog : "+ xtog);
    toggler = xtog;
    peerStartUp();
}
*/

function peerServerOn() {

	// and override the original config object
	// Call XirSys ICE servers
	$.ajax({
	  type: "POST",
	  url: "https://api.xirsys.com/getIceServers",
	  dataType: "json",
	  data: {

	    ident: "markkudlac",
	    secret: "10633c0a-fb06-4502-a834-de7d1990c3e6",
	    domain: "subsect.net",
	    application: "androidserver",
		room: "room-1",

	    /*
	    ident: "rosemaryp",
	    secret: "ddb1722f-43ca-4a52-9eed-449875634cc9",
	    domain: "www.adladl.com",
	    application: "subserv",
	    room: "room-1",
	    */
	    secure: 1
	  },
	  success: function (data, dstatus) {

		messout("Completed XirSys 2 : " + data.d.iceServers[0].url + "  status : " + dstatus);
	    setPeer(data.d);
	  },
	  error: function() {
	    messout("ERROR  XirSys");
	  }
	});
}


function setPeer(customConfig){

     connectcnt = 0;
     lastcontime = 0;

	//peer = new Peer($('#peerid').val(),
	peer = new Peer(
		{key: 'wcf528rijzx8byb9',
		debug: 3,
		config: customConfig
		});

	peer.on('error', function(err) {
	  messout('Peer server ERROR : ' + err.type + " : " + err.message);
	});


	peer.on('open', function(id) {

	  messout('My peer ID is: ' + id + " Name server : "+ getParam("subnamesrv"));
	  messout('My  subHostname is: ' + getParam("subhost"));

      timer = setInterval(function(){
        messout("sent PING");
			peer.socket.send({type: "PING", payload: {}});}, cycletime);

	  $.getJSON("http://"+getParam("subnamesrv")+"/api/setrtcid/"+ getParam("subhost") +"/"+id,
	    function(rtnobj){
	    messout("server rtn : " + rtnobj.rtn);

	    $("#servbut").val("Close Server")
	  //  android.transferPeer(id);
	   // timer = setTimeout(peerReset, cycletime);
	   // timer = setTimeout(peerStopConnect, cycletime);
	  })
	  .fail(function(xhr, text){
	    messout("server call failed : " + text);

	    peerShutDown();
	  });
	});


	peer.on('disconnected', function(){
		messout('Server has disconnected');
		peerShutDown();
	});


	peer.on('connection', function(conn) {

	  messout('Data connection started');
	  lastcontime = new Date().getTime();
	  ++connectcnt;

		conn.on('open', function() {
		  // Receive messages

		     messout('Data Connection openned cnt : ' + connectcnt);
		});

        conn.on('close', function() {
		  // Receive messages
		  --connectcnt;
		     messout('Data Connection closeded cnt : ' + connectcnt);
		});

        conn.on('data', function(rcv) {
		   // messout('Received ' + rcv.file);

              getappfile(rcv, conn);
		  });

		 conn.on('error', function(err) {
		    messout('Connection error : ' + err);
		});
	});


	peer.on('close', function() {
	  messout('Peer closed');
	});
}



function getappfile(rcv, xconn){

//console.log("Receive count : " + rcv.cnt + "  Receive mime : " + rcv.mimetp);

    if (rcv.cnt > 0)
    {
        var splitend = rcv.cnt * splitsz
        var xcnt = rcv.cnt + 1
        var tblob = blobbuff[rcv.file].slice((rcv.cnt - 1)*splitsz, splitend,
            blobbuff[rcv.file].type);

        if (tblob.size < splitsz || splitend == blobbuff[rcv.file].size)
        {
            xcnt = -1;
     // These caches should be cleaned up and only good for static files
     //       blobbuff[rcv.file] = null;
        }
        xconn.send({uri: rcv.file, blobtype: tblob.type, blob: tblob, cnt: xcnt});
        return;
    }

	var xhr = new XMLHttpRequest();
	xhr.onreadystatechange = function(){
	    if (this.readyState == 4 && this.status == 200){

            if (this.response.size > splitsz) {

                var yblob = this.response.slice(0, splitsz, this.response.type);

                if (blobbuff[rcv.file] === undefined || blobbuff[rcv.file] === null) {
                    blobbuff[rcv.file] = this.response.slice(splitsz,
                        this.response.size, this.response.type);
                }

                xconn.send({uri: rcv.file, blobtype: this.response.type, blob: yblob, cnt: 1});

            } else {
                xconn.send({uri: rcv.file, blobtype: this.response.type, blob: this.response, cnt: 0});
            }

		 }
	}
	xhr.open(rcv.type, 'http://' + fullPath(rcv.file));
	xhr.responseType = 'blob';
	if (rcv.mimetp.length > 0 ) {
	    xhr.overrideMimeType(rcv.mimetp);
	}
	xhr.send();
}


function fullPath(file) {

return(getParam("fullhost") + '/' + file);
}


function messout(mess){

	var xstr;

	xstr = $("#messout").val()
	$("#messout").val(xstr+'\\\n'+mess)
	$("textarea").scrollTop(99999)

}


	function initall() {
	$('#servbut').on("click",function(){
		if ($("#servbut").val().indexOf("St") == 0){
			peerStartUp();
	//		toggler = 0;
		} else {
			peerShutDown();
		}
	})

}


function peerStartUp(){

	shutdown = false;
	peerServerOn();
}

/*
function peerStopConnect() {

  //  console.log("In peerStopConnect");
    timer = setTimeout(peerShutDown, (cycletime * 4) / 5);
    android.callToggle(toggler+1);
}
*/

function peerShutDown(){

            shutdown = true;
            if (timer != null) {
                clearTimeout(timer);
                timer = null;
            }

			if (peer != null) {
			    peer.disconnect();
			    peer.destroy();
			}
			peer = null;
			$("#servbut").val("Start Server")
}


/*
function peerReset(){

console.log("In peerRest conectcnt : "+connectcnt);
    if (connectcnt <= 0 || new Date().getTime() - lastcontime > 60000 * 20) {
        peerShutDown()
        peerStartUp()
    } else {
        timer = setTimeout(peerReset, 60000);
    }
}
*/

function getParam(val) {

    tmp = [];
    var items = location.search.substr(1).split("&");
    for (var index = 0; index < items.length; index++) {
        tmp = items[index].split("=");
        if (tmp[0] === val) return(tmp[1]);
    }
    return "";
}
</script>

</body>
</html>