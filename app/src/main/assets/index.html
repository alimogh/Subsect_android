
<!DOCTYPE html>
<html>

<head>
   <script src="file:///android_asset/peer.0.3.13.js"></script>
    <script src="file:///android_asset/jquery-2.1.3.min.js"></script>
</head>

<body>
    <input id="servbut" type="button" value="Start Server" />
    <textarea id="messout" rows="20" style="width: 100%; margin-top: 10px"></textarea>

<script>

var peer = null;
var shutdown = false;
var blobbuff = {};

var connectcnt = 0;
var timer = null;
var cycletime = 60000 * 4;

var restarttimer = null;
var restartcnt = 0;

var splitsz = 65536 * 2;

	$(document).ready(function(){
		messout("localhost : " + getParam("fullhost"));
		initall();
		peerServerOn();
	})


function peerServerOn() {

	// and override the original config object
	// Call XirSys ICE servers

    $.ajax({
      type: "POST",
      url: "https://service.xirsys.com/ice",
      dataType: "json",
      data: {

        ident: "markkudlac",
        secret: "10633c0a-fb06-4502-a834-de7d1990c3e6",
        domain: "subsect.net",
        application: "subserver",
        room: "default",

        /*
        ident: "rosemaryp",
        secret: "ddb1722f-43ca-4a52-9eed-449875634cc9",
        domain: "www.adladl.com",
        application: "subserver",
        room: "default",
        */
        secure: 1,
        timeout: 600
      },
      success: function (data, dstatus) {
        messout("XirSys : " + data.d.iceServers[0].url + "  status : " + dstatus);
        setPeer(data.d);
      },
      error: function() {
            messout("ERROR XirSys reset");
            peerReStart();
      }
    });
}


function setPeer(customConfig){

     connectcnt = 0;

    var opts  = {key: 'wcf528rijzx8byb9',
	//	debug: 3
		};

	if (customConfig !== null) opts.config = customConfig;
	peer = new Peer(opts);

	peer.on('error', function(err) {
	    peerReStart();
	    messout('Peer server ERROR : ' + err.type + " : " + err.message);
	});


	peer.on('open', function(id) {

	  messout('My peer ID is: ' + id + " Name server : "+ getParam("subnamesrv"));
	  messout('My  subHostname is: ' + getParam("subhost"));

      timer = setInterval(function(){
        messout("sent PING");
			peer.socket.send({type: "PING", payload: {}});}, cycletime);

	  $.getJSON("http://"+getParam("subnamesrv")+"/api/setrtcid/"+ getParam("subhost") +"/"+id,
	    function(rtnobj){
	    messout("server rtn : " + rtnobj.rtn);
        clearReStart();
	    $("#servbut").val("Close Server")
	  })
	  .fail(function(xhr, text){
	    messout("server call failed : " + text);

	    peerShutDown();
	  });
	});


	peer.on('disconnected', function(){
		messout('Server has disconnected');
		peerReStart();
	});


	peer.on('connection', function(conn) {

	  messout('Data connection started');
	  ++connectcnt;

		conn.on('open', function() {
		  // Receive messages

		     messout('Data Connection openned cnt : ' + connectcnt);
		});

        conn.on('close', function() {
		  // Receive messages
		  --connectcnt;
		     messout('Data Connection closeded cnt : ' + connectcnt);
		});

        conn.on('data', function(rcv) {
		    messout('Received ' + rcv.file);

              getappfile(rcv, conn);
		  });

		 conn.on('error', function(err) {
		    messout('Connection error : ' + err);
		});
	});

	peer.on('close', function() {
	  messout('Peer closed');
	});
}



function getappfile(rcv, xconn){

//console.log("Receive count : " + rcv.cnt + "  Receive mime : " + rcv.mimetp);

    if (rcv.cnt > 0)
    {
        var splitend = rcv.cnt * splitsz
        var xcnt = rcv.cnt + 1
        var tblob = blobbuff[rcv.file].slice((rcv.cnt - 1)*splitsz, splitend,
            blobbuff[rcv.file].type);

        if (tblob.size < splitsz || splitend == blobbuff[rcv.file].size)
        {
            xcnt = -1;
     // These caches should be cleaned up and only good for static files
     //       blobbuff[rcv.file] = null;
        }
        xconn.send({uri: rcv.file, blobtype: tblob.type, blob: tblob, cnt: xcnt});
        return;
    }

	var xhr = new XMLHttpRequest();
	xhr.onreadystatechange = function(){
	    if (this.readyState == 4 && this.status == 200){

            if (this.response.size > splitsz) {

                var yblob = this.response.slice(0, splitsz, this.response.type);

                if (blobbuff[rcv.file] === undefined || blobbuff[rcv.file] === null) {
                    blobbuff[rcv.file] = this.response.slice(splitsz,
                        this.response.size, this.response.type);
                }

                xconn.send({uri: rcv.file, blobtype: this.response.type, blob: yblob, cnt: 1});

            } else {
                xconn.send({uri: rcv.file, blobtype: this.response.type, blob: this.response, cnt: 0});
            }

		 }
	}

	// console.log("Receive type : " + rcv.type + "  Receive args : " + rcv.args);

    var httpfl = 'http://' + fullPath(rcv.file);

    if (rcv.type === "POST") {
	    xhr.open(rcv.type, httpfl);
	    xhr.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
	} else {
	    xhr.open(rcv.type, httpfl+"?"+rcv.args);
	}

	xhr.responseType = 'blob';
	if (rcv.mimetp.length > 0 ) {
	    xhr.overrideMimeType(rcv.mimetp);
	}

	if (rcv.type === "POST") {
	    xhr.send(rcv.args);
	} else {
	    xhr.send();
	}
}


function fullPath(file) {

return(getParam("fullhost") + '/' + file);
}


function messout(mess){

	var xstr;

	xstr = $("#messout").val()
	$("#messout").val(xstr+'\\\n'+mess)
	$("textarea").scrollTop(99999)

}


function initall() {
	$('#servbut').on("click",function(){
		if ($("#servbut").val().indexOf("St") == 0){
		    clearReStart();
			peerStartUp();
		} else {
			peerShutDown();
		}
	})

}


function peerStartUp(){

	shutdown = false;
	peerServerOn();
}


function peerShutDown(){

    if (!shutdown) serverOffline();

    shutdown = true;
    if (timer != null) {
        clearTimeout(timer);
        timer = null;
    }

    if (peer != null) {
        peer.disconnect();
        peer.destroy();
    }
    peer = null;
    $("#servbut").val("Start Server");
}


function peerReStart(){

    if (!shutdown && restartcnt == 0) {
        restartcnt = 1;
        restarttimer = setTimeout(loopReStart, restartcnt * 60000);
    }
}


function loopReStart(){

    peerShutDown();

    if (restartcnt <= 5) {
        messout("In loopReset : " + restartcnt);
        ++restartcnt;
        restarttimer = setTimeout(loopReStart, restartcnt * 60000);
       peerStartUp();
    } else {
        clearReStart();
    }
}

function clearReStart(){

    restartcnt = 0;
    if (restarttimer != null) {
        clearTimeout(restarttimer);
        restarttimer = null;
    }
}


function getParam(val) {

    tmp = [];
    var items = location.search.substr(1).split("&");
    for (var index = 0; index < items.length; index++) {
        tmp = items[index].split("=");
        if (tmp[0] === val) return(tmp[1]);
    }
    return "";
}


function serverOffline(){

    $.getJSON("http://"+getParam("subnamesrv")+"/api/offline/"+ getParam("subhost"),
	    function(rtnobj){
	    messout("Offline rtn : " + rtnobj.rtn);
	  })
	  .fail(function(xhr, text){
	    messout("Offline call failed : " + text);
	  });
}
</script>

</body>
</html>