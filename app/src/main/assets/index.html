
<!DOCTYPE html>
<html>

<head>
    <title>Subsect Server</title>

    <script src="http://cdn.peerjs.com/0.3/peer.min.js"></script>
    <script src="http://code.jquery.com/jquery-2.1.3.min.js"></script>
</head>

<body>

<h2>Subsect Server</h2>

<div>
    <input id="peerid" type="text" value="" /> <br/>
    <input id="servbut" type="button" style="margin-top: 20px" value="Start Server" />
    <textarea id="messout" rows="10" style="width: 100%; margin-top: 20px"></textarea>
</div>

<script>

var peer = null;
var shutdown = false;
var blobbuff = {};

var connectcnt = 0;
var lastcontime = 0;
var timer = null;

var splitsz = 100000;

	$(document).ready(function(){
		messout("localhost : " + android.localhostaddress())

		initall();
	})


function peerServerOn() {

	// and override the original config object
	// Call XirSys ICE servers
	$.ajax({
	  type: "POST",
	  dataType: "json",
	  url: "https://api.xirsys.com/getIceServers",
	  data: {
	    ident: "markkudlac",
	    secret: "1e2822c6-88b3-4e20-8ecf-5bb64475d424",
	    domain: "subsect.net",
	    application: "default",
	    room: "default",
	    secure: 1
	  },
	  success: function (data, status) {
		messout("Completed XirSys");
	    setPeer(data.d);
	  },
	  error: function() {
	    messout("ERROR  XirSys");
	  }
	});
}


function setPeer(customConfig){

     connectcnt = 0;
     lastcontime = 0;

	peer = new Peer($('#peerid').val(),
		{key: 'wcf528rijzx8byb9',
		debug: 3,
		config: customConfig});

	peer.on('error', function(err) {
	  messout('ERROR : ' + err.type);
	});


	peer.on('open', function(id) {

	  messout('My peer ID is: ' + id + " Name server : "+ getParam("subnamesrv"));
	  messout('My  subHostname is: ' + getParam("subhost"));

	  $.getJSON("http://"+getParam("subnamesrv")+"/api/setrtcid/"+ getParam("subhost") +"/"+id,
	    function(rtnobj){
	    messout("server rtn : " + rtnobj.rtn);

	    $("#servbut").val("Close Server")
	    timer = setTimeout(peerReset, 60000 * 12);
	  })
	  .fail(function(xhr, text){
	    messout("server call failed : " + text);

	    peerShutDown();
	  });
	});


	peer.on('disconnected', function(){
		messout('Server has disconnected');

		peerShutDown();
	});


	peer.on('connection', function(conn) {

	  messout('Data connection started');
	  lastcontime = new Date().getTime();
	  ++connectcnt;

		conn.on('open', function() {
		  // Receive messages

		     messout('Data Connection openned cnt : ' + connectcnt);
		});

        conn.on('close', function() {
		  // Receive messages
		  --connectcnt;
		     messout('Data Connection closeded cnt : ' + connectcnt);
		});

            conn.on('data', function(rcv) {
		   // messout('Received ' + rcv.file);

                if (rcv.file.indexOf("sub_ping") == 0) {
                    messout('Got Ping');
                } else {
                    getappfile(rcv, conn);
                }
		  });

		 conn.on('error', function(err) {
		    messout('Connection error : ' + err);
		});
	});


	peer.on('close', function() {
	  messout('Peer closed');
	});
}



function getappfile(rcv, xconn){

//console.log("Receive count : " + rcv.cnt + "  Receive file : " + rcv.file);

    if (rcv.cnt > 0)
    {
        var splitend = rcv.cnt * splitsz
        var xcnt = rcv.cnt + 1
        var tblob = blobbuff[rcv.file].slice((rcv.cnt - 1)*splitsz, splitend,
            blobbuff[rcv.file].type);

  //      console.log("Respose size 1 : " +tblob.size + "  type : "+ tblob.type);
        if (tblob.size < splitsz || splitend == blobbuff[rcv.file].size)
        {
            xcnt = -1;
     // These caches should be cleaned up and only good for static files
     //       blobbuff[rcv.file] = null;
        }
        xconn.send({uri: rcv.file, blobtype: tblob.type, blob: tblob, cnt: xcnt});
        return;
    }

	var xhr = new XMLHttpRequest();
	xhr.onreadystatechange = function(){
	    if (this.readyState == 4 && this.status == 200){
            console.log("Respose size 4 : " +this.response.size + "  type : "+this.response.type);

            if (this.response.size > splitsz) {

                var yblob = this.response.slice(0, splitsz, this.response.type);

                if (blobbuff[rcv.file] === undefined || blobbuff[rcv.file] === null) {
                console.log("Putting into blobbuff : " + rcv.file)
                    blobbuff[rcv.file] = this.response.slice(splitsz,
                        this.response.size, this.response.type);
                }

  //              console.log("Respose size 5 : " +yblob.size + "  type : "+ yblob.type);
                xconn.send({uri: rcv.file, blobtype: this.response.type, blob: yblob, cnt: 1});

            } else {
                xconn.send({uri: rcv.file, blobtype: this.response.type, blob: this.response, cnt: 0});
            }

		 }
	}
	xhr.open(rcv.type, 'http://' + fullPath(rcv.file));
	xhr.responseType = 'blob';
	xhr.send();
}


function fullPath(file) {

return(android.localhostaddress() + '/' + file);
}


function messout(mess){

	var xstr;

	xstr = $("#messout").val()
	$("#messout").val(xstr+'\\\n'+mess)
	$("textarea").scrollTop(99999)

}


	function initall() {
	$('#servbut').on("click",function(){
//		console.log("destbut: pressed")
		if ($("#servbut").val().indexOf("St") == 0){
			peerStartUp();
		} else {
			peerShutDown();
		}
	})
	
	
}


function peerStartUp(){

			shutdown = false;
			peerServerOn();
}


function peerShutDown(){

            shutdown = true;
            if (timer != null) {
                clearTimeout(timer);
                timer = null;
            }
			 if (peer != null) peer.destroy();
			peer = null;
			$("#servbut").val("Start Server")
}


function peerReset(){

console.log("In peerRest conectcnt : "+connectcnt);
    if (connectcnt <= 0 || new Date().getTime() - lastcontime > 60000 * 20) {
        peerShutDown()
        peerStartUp()
    } else {
        timer = setTimeout(peerReset, 60000);
    }
}


function getParam(val) {

    tmp = [];
    var items = location.search.substr(1).split("&");
    for (var index = 0; index < items.length; index++) {
        tmp = items[index].split("=");
        if (tmp[0] === val) return(tmp[1]);
    }
    return "";
}
</script>

</body>
</html>