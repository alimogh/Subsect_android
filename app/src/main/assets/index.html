<html>

<head>
    <title>Subsect Server</title>

    <script src="http://cdn.peerjs.com/0.3/peer.min.js"></script>
    <script src="http://code.jquery.com/jquery-2.1.3.min.js"></script>
</head>

<!-- API Key wcf528rijzx8byb9  -->

<body>

<h1>Subsect Server</h1>

<div>
    <input id="peerid" type="text" value="fred1" /> <br/>
    <input id="servbut" type="button" style="margin-top: 20px" value="Start Server" />
    <textarea id="messout" rows="10" style="width: 100%; margin-top: 20px"></textarea>
</div>

<script>

var peer = null;
//var xconn = null;

var shutdown = false;


function peerServerOn() {

	// and override the original config object
	// Call XirSys ICE servers
	$.ajax({
	  type: "POST",
	  dataType: "json",
	  url: "https://api.xirsys.com/getIceServers",
	  data: {
	    ident: "markkudlac",
	    secret: "1e2822c6-88b3-4e20-8ecf-5bb64475d424",
	    domain: "subsect.net",
	    application: "default",
	    room: "default",
	    secure: 1
	  },
	  success: function (data, status) {
			messout("Completed XirSys");
//	    console.log(data.d);

	    // data.d is where the iceServers object lives
	    setPeer(data.d);
	  }
	});
}


function setPeer(customConfig){

	peer = new Peer($('#peerid').val(),
		{key: 'wcf528rijzx8byb9',
		debug: 3,
		config: customConfig});

	peer.on('error', function(err) {
	  messout('ERROR : ' + err.type);
	});


	peer.on('open', function(id) {
	  messout('My peer ID is: ' + id);
	});


	peer.on('disconnected', function(){
		messout('Server has disconnected');

		if (! shutdown) {
			messout('Calling reconnect');
			peer.reconnect();
		}
	});


	peer.on('connection', function(conn) {
	  messout('Data connection started');
		conn.on('open', function() {
		  // Receive messages
		  conn.on('data', function(rcvfile) {
		    messout('Received ' + rcvfile);

			  // Send messages
//			  conn.send({datatype: rcvfile, data: rtnval(rcvdata)});
               getappfile(rcvfile, conn)
		  });
		});
	});
}


	/*
function	rtnval(rqtype){
		var rtnstr="none"
	
	if (rqtype.indexOf("html") == 0){

		rtnstr = '\<p id="butbuf"\> \
		\<button id="alertbut"\>Alert\</button\>\
	\</p\>'

	} else if (rqtype.indexOf("js") == 0){
		rtnstr = '$("#alertbut").on("click", function(){\
		 console.log("press destjs");\
	 	alert("Button pressed")})'
	} else if (rqtype.indexOf("css") == 0){
		rtnstr = '#butbuf{height: 100px; width: 200px; background-color: #b0c4de; text-align: center;}\
		#alertbut{width:75px; height:30px; margin-top: 35px;}'
	}
		
		return rtnstr
}
*/


function getappfile(rcvfile, xconn){

		var xhr = new XMLHttpRequest();
		xhr.onreadystatechange = function(){
		    if (this.readyState == 4 && this.status == 200){
		        //this.response is what you're looking for

		        console.log("Respose type 4 : " + typeof this.response);
                console.log("Respose length 4 : " +this.response.size + "  type : "+this.response.type);

//		        var img = document.getElementById('tstimg');
//		        var url = window.URL || window.webkitURL;
//		        img.src = url.createObjectURL(this.response);

                xconn.send({uri: rcvfile, blobtype: this.response.type, blob: this.response});
        // xconn.send(this.response);
		    }
		}
//		xhr.open('GET', 'http://192.168.1.108:8080/'+rcvfile);
		xhr.open('GET', 'http://localhost:8080/'+rcvfile);
		// xhr.responseType = 'text';
		xhr.responseType = 'blob';
		xhr.send();

}



function messout(mess){
	
	var xstr;
	
	xstr = $("#messout").val()
	$("#messout").val(xstr+'\\\n'+mess)
	$("textarea").scrollTop(99999)
	
}


	$(document).ready(function(){
		messout("Server document ready")
	
		initall();
	})
	

	function initall() {
	$('#servbut').on("click",function(){
//		console.log("destbut: pressed")
		if ($("#servbut").val().indexOf("St") == 0){
			shutdown = false;
			peerServerOn();
			$("#servbut").val("Close Server")
		} else {
			shutdown = true;
			peer.destroy();
			peer = null;
			$("#servbut").val("Start Server")
		}
	})
	
	
}

</script>

</body>
</html>